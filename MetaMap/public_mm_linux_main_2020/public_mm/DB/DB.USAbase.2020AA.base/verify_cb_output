#!/bin/ksh

PROGRAM=`basename $0`

if [ $# -ne 1 ]
then
   echo "Usage: $PROGRAM [ 01 | vars ]"
   exit 1
elif [ ! -f config.$1 ]
then
   echo "Usage: $PROGRAM [ 01 | vars ]"
   exit 1
fi

TYPE=$1
CONFIG_FILE=config.${TYPE}
CREATE_BULK_LOGFILE=create_bulk.log.${TYPE}

# look for lines that
# (1)  begin with a character other than '#', and
# (2) contain a '|'
grep '^[^#].*|' $CONFIG_FILE | cut -d'|' -f1,2 | while read FILE_DATA
do
   # echo $FILE_DATA
   TXT_FILE=`echo $FILE_DATA | sed -e 's/|.*//'`
   DBFILE=`echo $FILE_DATA | sed -e 's/.*|//'`
   # echo $TXT_FILE $DBFILE

   # Do not do simply wc -l $TXT_FILE so as to avoid the filename in the output of wc
   TXTFILE_WC=`cat $TXT_FILE | wc -l`

   # The output of create_bulk looks like this:

   # Processing Table: nlsaa from /nfsvol/nls3aux18/DB/DB.normal.08.strict
   # Completed /nfsvol/nls3aux18/DB/DB.normal.08.moderate/nls_aa.txt 10000
   # Completed /nfsvol/nls3aux18/DB/DB.normal.08.moderate/nls_aa.txt 20000
   # Completed /nfsvol/nls3aux18/DB/DB.normal.08.moderate/nls_aa.txt 30000
   # Completed /nfsvol/nls3aux18/DB/DB.normal.08.moderate/nls_aa.txt 40000
   # Completed /nfsvol/nls3aux18/DB/DB.normal.08.moderate/nls_aa.txt 50000
   # Completed /nfsvol/nls3aux18/DB/DB.normal.08.moderate/nls_aa.txt 60000
   # FINISHED /nfsvol/nls3aux18/DB/DB.normal.08.moderate/nls_aa.txt 64184
   # Processing Table: nlsaau from /nfsvol/nls3aux18/DB/DB.normal.08.strict
   # Completed /nfsvol/nls3aux18/DB/DB.normal.08.moderate/nls_aau.tx 10000
   # Completed /nfsvol/nls3aux18/DB/DB.normal.08.moderate/nls_aau.tx 20000
   # FINISHED /nfsvol/nls3aux18/DB/DB.normal.08.moderate/nls_aau.tx 26612

   # We want to grab the "FINISHED" line for each file,
   # and keep the number of lines generated by create_bulk.

   CREATE_BULK_WC=` grep "^FINISHED.*$TXT_FILE" $CREATE_BULK_LOGFILE | sed -e 's/.* //'`

   let "DIFF  = TXTFILE_WC - CREATE_BULK_WC"

   if [ $DIFF -eq 0 ]
   then
      echo "$TXT_FILE/$DBFILE diff OK: $DIFF/$TXTFILE_WC"
   else
      echo "################################################################"
      echo "ERROR ##########################################################"
      echo "SIGNIFICANT $TXT_FILE DIFF: $DIFF ($TXTFILE_WC - $CREATE_BULK_WC)"
      echo "ERROR ##########################################################"
      echo "################################################################"
   fi
done
